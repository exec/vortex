name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.4.0). If not provided, will use latest git tag.'
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Create package
        run: |
          mkdir -p package/bin
          cp target/${{ matrix.target }}/release/vortex package/bin/
          cp README.md LICENSE package/

          # Create install script
          cat > package/install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing Vortex..."

          # Check for krunvm dependency
          if ! command -v krunvm &> /dev/null; then
              echo "Warning: krunvm not found. Install with: brew install krunvm"
          fi

          # Install binary
          sudo mkdir -p /usr/local/bin
          sudo cp bin/vortex /usr/local/bin/
          sudo chmod +x /usr/local/bin/vortex

          echo "Vortex installed successfully!"
          echo "Run 'vortex --help' to get started."
          EOF
          chmod +x package/install.sh

      - name: Create archive
        run: |
          cd package
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          tar -czf ../vortex-$TAG_NAME-${{ matrix.target }}.tar.gz *

      - name: Release and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          # Upload the asset
          gh release upload "$TAG_NAME" ./vortex-$TAG_NAME-${{ matrix.target }}.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Create generic Linux package
        run: |
          mkdir -p package/bin package/systemd
          cp target/x86_64-unknown-linux-gnu/release/vortex package/bin/
          cp README.md LICENSE package/
          cp ./systemd/vortex-daemon.service package/systemd/

          # Create install script
          cat > package/install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing Vortex..."

          # Install binary
          sudo mkdir -p /usr/local/bin
          sudo cp bin/vortex /usr/local/bin/
          sudo chmod +x /usr/local/bin/vortex

          echo "Vortex installed successfully!"
          echo "Note: You'll need krunvm or Firecracker installed separately."
          echo "Run 'vortex --help' to get started."
          EOF
          chmod +x package/install.sh

      - name: Create archive
        run: |
          cd package
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          tar -czf ../vortex-$TAG_NAME-x86_64-unknown-linux-gnu.tar.gz *

      - name: Release and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          # Upload the asset
          gh release upload "$TAG_NAME" ./vortex-$TAG_NAME-x86_64-unknown-linux-gnu.tar.gz

  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortex-daemon.service package/systemd/

      - name: Create DEB package
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}

          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/share/vortex
          mkdir -p deb-package/usr/share/doc/vortex

          cp target/x86_64-unknown-linux-gnu/release/vortex deb-package/usr/bin/
          chmod +x deb-package/usr/bin/vortex

          cp package/systemd/vortex-daemon.service deb-package/usr/share/vortex/
          cp README.md LICENSE deb-package/usr/share/doc/vortex/

          cat > deb-package/DEBIAN/control << EOF
          Package: vortex
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Vortex Contributors <noreply@github.com>
          Description: Lightning-fast ephemeral VM platform
          Homepage: https://github.com/exec/vortex
          EOF

          cat > deb-package/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Vortex systemd service..."
          sudo cp /usr/share/vortex/vortex-daemon.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable vortex-daemon
          sudo systemctl start vortex-daemon
          exit 0
          EOF
          chmod +x deb-package/DEBIAN/postinst

          cat > deb-package/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "remove" ]; then
            sudo systemctl disable vortex-daemon 2>/dev/null || true
            sudo systemctl stop vortex-daemon 2>/dev/null || true
            sudo rm -f /etc/systemd/system/vortex-daemon.service
            sudo systemctl daemon-reload
          fi
          exit 0
          EOF
          chmod +x deb-package/DEBIAN/postrm

          dpkg-deb --build deb-package vortex_${VERSION}_amd64.deb

      - name: Release and Upload DEB
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          VERSION=${{ steps.get_version.outputs.version }}
          gh release upload "$TAG_NAME" ./vortex_${VERSION}_amd64.deb

  build-arch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortex-daemon.service package/systemd/

      - name: Create PKGARCH package
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}

          mkdir -p pkgarch-build/usr/bin
          mkdir -p pkgarch-build/usr/share/vortex
          mkdir -p pkgarch-build/usr/share/doc/vortex

          cp target/x86_64-unknown-linux-gnu/release/vortex pkgarch-build/usr/bin/
          chmod +x pkgarch-build/usr/bin/vortex

          cp package/systemd/vortex-daemon.service pkgarch-build/usr/share/vortex/
          cp README.md LICENSE pkgarch-build/usr/share/doc/vortex/

          cat > pkgarch-build/.PKGINFO << EOF
          pkgname = vortex
          pkgver = $VERSION
          pkgdesc = Lightning-fast ephemeral VM platform
          url = https://github.com/exec/vortex
          builddate = $(date +%s)
          packager = Vortex Contributors <noreply@github.com>
          size = $(du -sb pkgarch-build | cut -f1)
          arch = x86_64
          license = MIT
          EOF

          cat > pkgarch-build/.MTREE << EOF
          #/.snapshots
          EOF

          cat > pkgarch-build/PKGBUILD << 'EOF'
          pkgname=vortex
          pkgver=$VERSION
          pkgrel=1
          pkgdesc="Lightning-fast ephemeral VM platform"
          arch=('x86_64')
          url="https://github.com/exec/vortex"
          license=('MIT')
          package() {
            mkdir -p "$pkgdir/usr/bin"
            cp /usr/bin/vortex "$pkgdir/usr/bin/"
            mkdir -p "$pkgdir/usr/share/vortex"
            cp /usr/share/vortex/vortex-daemon.service "$pkgdir/usr/share/vortex/"
          }
          EOF

          cat > pkgarch-build/vortex.install << 'EOF'
          post_install() {
            cp /usr/share/vortex/vortex-daemon.service /etc/systemd/system/
            systemctl daemon-reload
            systemctl enable vortex-daemon
            systemctl start vortex-daemon
          }
          post_remove() {
            systemctl disable vortex-daemon 2>/dev/null || true
            systemctl stop vortex-daemon 2>/dev/null || true
            rm -f /etc/systemd/system/vortex-daemon.service
            systemctl daemon-reload
          }
          post_upgrade() { post_install; }
          EOF
          chmod +x pkgarch-build/vortex.install

          cd pkgarch-build
          tar -czf ../vortex-$VERSION-x86_64-unknown-linux-gnu.pkg.tar.gz .
          cd ..

          cat > vortex-arch-install.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Vortex..."
          VERSION="${1:-v0.5.0}"
          DOWNLOAD_URL="https://github.com/exec/vortex/releases/download/$VERSION/vortex-$VERSION-x86_64-unknown-linux-gnu.pkg.tar.gz"
          TEMP_DIR=$(mktemp -d)
          curl -sL "$DOWNLOAD_URL" | tar -xzf - -C "$TEMP_DIR"
          sudo mkdir -p /usr/bin /usr/share/vortex /usr/share/doc/vortex
          sudo cp "$TEMP_DIR/usr/bin/vortex" /usr/bin/
          sudo cp "$TEMP_DIR/usr/share/vortex/vortex-daemon.service" /usr/share/vortex/
          sudo cp /usr/share/vortex/vortex-daemon.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable vortex-daemon
          sudo systemctl start vortex-daemon
          rm -rf "$TEMP_DIR"
          echo "Vortex installed successfully!"
          EOF
          chmod +x vortex-arch-install.sh

      - name: Release and Upload Arch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          VERSION=${TAG_NAME#v}
          gh release upload "$TAG_NAME" ./vortex-$VERSION-x86_64-unknown-linux-gnu.pkg.tar.gz
          gh release upload "$TAG_NAME" ./vortex-arch-install.sh

  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential rpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortex-daemon.service package/systemd/

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Create RPM package
        run: |
          VERSION=${{ github.ref_name }}
          VERSION=${VERSION#v}

          mkdir -p rpm-build/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpm-build/SOURCES/vortex-$VERSION/{usr/bin,usr/share/vortex,usr/share/doc/vortex}

          cp target/x86_64-unknown-linux-gnu/release/vortex rpm-build/SOURCES/vortex-$VERSION/usr/bin/
          chmod +x rpm-build/SOURCES/vortex-$VERSION/usr/bin/vortex
          cp package/systemd/vortex-daemon.service rpm-build/SOURCES/vortex-$VERSION/usr/share/vortex/
          cp README.md LICENSE rpm-build/SOURCES/vortex-$VERSION/usr/share/doc/vortex/

          cd rpm-build/SOURCES
          tar -czf vortex-$VERSION.tar.gz vortex-$VERSION/
          cd ../..

          cat > rpm-build/SPECS/vortex.spec << EOF
          Name:           vortex
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Lightning-fast ephemeral VM platform
          License:        MIT
          URL:            https://github.com/exec/vortex
          Source0:        %{name}-%{version}.tar.gz
          BuildArch:      x86_64

          %description
          Vortex is a powerful Rust CLI for creating and managing ephemeral
          microVMs using krunvm on macOS and Linux.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/vortex
          mkdir -p %{buildroot}/usr/share/doc/vortex
          cp usr/bin/vortex %{buildroot}/usr/bin/
          cp usr/share/vortex/vortex-daemon.service %{buildroot}/usr/share/vortex/
          cp usr/share/doc/vortex/* %{buildroot}/usr/share/doc/vortex/

          %files
          /usr/bin/vortex
          /usr/share/vortex/vortex-daemon.service
          /usr/share/doc/vortex/*

          %post
          cp /usr/share/vortex/vortex-daemon.service /etc/systemd/system/
          systemctl daemon-reload
          systemctl enable vortex-daemon
          systemctl start vortex-daemon
          echo "Vortex installed successfully!"

          %changelog
          * $(date +"%%a %%b %%d %%Y") Vortex Contributors <noreply@github.com> - $VERSION-1
          - Release $VERSION
          EOF

          rpmbuild --define "_topdir $(pwd)/rpm-build" -bb rpm-build/SPECS/vortex.spec

          find rpm-build/RPMS -name "*.rpm" -exec cp {} ./vortex-$VERSION-1.x86_64.rpm \;

      - name: Release and Upload RPM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          VERSION=${TAG_NAME#v}
          gh release upload "$TAG_NAME" ./vortex-$VERSION-1.x86_64.rpm

  create-install-script:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create universal install script
        run: |
          cat > install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing Vortex..."

          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)

          case $ARCH in
            x86_64) ARCH="x86_64" ;;
            arm64|aarch64) ARCH="aarch64" ;;
            *) echo "Unsupported architecture: $ARCH" && exit 1 ;;
          esac

          case $OS in
            darwin) TARGET="${ARCH}-apple-darwin" ;;
            linux) TARGET="${ARCH}-unknown-linux-gnu" ;;
            *) echo "Unsupported OS: $OS" && exit 1 ;;
          esac

          LATEST_RELEASE=$(curl -s https://api.github.com/repos/exec/vortex/releases/latest | grep '"tag_name":' | cut -d'"' -f4)
          if [ -z "$LATEST_RELEASE" ]; then
            echo "Failed to get latest release information"
            exit 1
          fi

          echo "Installing Vortex $LATEST_RELEASE for $OS/$ARCH"

          DOWNLOAD_URL="https://github.com/exec/vortex/releases/download/$LATEST_RELEASE/vortex-$LATEST_RELEASE-$TARGET.tar.gz"
          TEMP_DIR=$(mktemp -d)

          echo "Downloading from $DOWNLOAD_URL..."
          if command -v curl &> /dev/null; then
            curl -sL "$DOWNLOAD_URL" | tar -xzf - -C "$TEMP_DIR"
          elif command -v wget &> /dev/null; then
            wget -qO- "$DOWNLOAD_URL" | tar -xzf - -C "$TEMP_DIR"
          else
            echo "Error: curl or wget is required"
            exit 1
          fi

          echo "Installing to /usr/local/bin..."
          sudo mkdir -p /usr/local/bin
          sudo cp "$TEMP_DIR/bin/vortex" /usr/local/bin/
          sudo chmod +x /usr/local/bin/vortex

          rm -rf "$TEMP_DIR"

          echo "Vortex installed successfully!"
          echo "Run 'vortex --help' to get started."
          EOF

          chmod +x install.sh

      - name: Release and Upload Install Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./install.sh --clobber
