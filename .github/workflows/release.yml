name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.4.0). If not provided, will use latest git tag.'
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Create package
        run: |
          mkdir -p package/bin
          cp target/${{ matrix.target }}/release/vortex package/bin/
          cp README.md LICENSE package/

          # Create install script
          cat > package/install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing Vortex..."

          # Check for krunvm dependency
          if ! command -v krunvm &> /dev/null; then
              echo "Warning: krunvm not found. Install with: brew install krunvm"
          fi

          # Install binary
          sudo mkdir -p /usr/local/bin
          sudo cp bin/vortex /usr/local/bin/
          sudo chmod +x /usr/local/bin/vortex

          echo "Vortex installed successfully!"
          echo "Run 'vortex --help' to get started."
          EOF
          chmod +x package/install.sh

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi

          # Map target to simplified naming for install.sh compatibility
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
            TARGET_NAME="macos-amd64"
          elif [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            TARGET_NAME="macos-arm64"
          else
            TARGET_NAME="${{ matrix.target }}"
          fi

          echo "TAG_NAME=$TAG_NAME"
          echo "TARGET_NAME=$TARGET_NAME"
          echo "archive_name=vortex-$TAG_NAME-${TARGET_NAME}.tar.gz" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "target_name=$TARGET_NAME" >> $GITHUB_OUTPUT

      - name: Create archive
        working-directory: package
        run: |
          tar -czf ../${{ steps.version_vars.outputs.archive_name }} *

      - name: Release and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          ARCHIVE_NAME="${{ steps.version_vars.outputs.archive_name }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          # Upload the asset
          ls -la "$ARCHIVE_NAME" 2>/dev/null || echo "File not found"
          gh release upload "$TAG_NAME" ./"$ARCHIVE_NAME"

  build-macos-pkg:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build universal binary
        run: |
          cargo build --release --target x86_64-apple-darwin
          cargo build --release --target aarch64-apple-darwin
          lipo -create -output target/universal/release/vortex \
            target/x86_64-apple-darwin/release/vortex \
            target/aarch64-apple-darwin/release/vortex

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME"
          echo "VERSION=$VERSION"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create PKG installer
        run: |
          VERSION="${{ steps.version_vars.outputs.version }}"
          mkdir -p package/bin
          cp target/universal/release/vortex package/bin/
          cp README.md LICENSE package/
          cp ./systemd/vortexd.service package/systemd/ || true

          # Create the package structure
          mkdir -p pkg-build/vortex-$VERSION
          cp -r package/* pkg-build/vortex-$VERSION/

          # Create the product definition
          cat > pkg-build/productdef.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="1">
            <title>Vortex</title>
            <pkg-ref id="vortex" version="$VERSION" installKBytes="10000">
              <payload directory="vortex-$VERSION"/>
            </pkg-ref>
            <choices-outline>
              <line choice="vortex"/>
            </choices-outline>
            <choice id="vortex">
              <pkg-ref id="vortex"/>
            </choice>
          </installer-gui-script>
          EOF

          # Build the package
          pkgbuild --root pkg-build/vortex-$VERSION \
            --identifier vortex \
            --version $VERSION \
            --install-location /usr/local \
            vortex-$VERSION.pkg

      - name: Release and Upload PKG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          VERSION="${{ steps.version_vars.outputs.version }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./vortex-$VERSION.pkg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          echo "TAG_NAME=$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Create generic Linux package
        run: |
          mkdir -p package/bin package/systemd
          cp target/x86_64-unknown-linux-gnu/release/vortex package/bin/
          cp README.md LICENSE package/
          cp ./systemd/vortexd.service package/systemd/

          # Create install script
          cat > package/install.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "Installing Vortex..."

          # Install binary
          sudo mkdir -p /usr/local/bin
          sudo cp bin/vortex /usr/local/bin/
          sudo chmod +x /usr/local/bin/vortex

          echo "Vortex installed successfully!"
          echo "Note: You'll need krunvm or Firecracker installed separately."
          echo "Run 'vortex --help' to get started."
          EOF
          chmod +x package/install.sh

      - name: Create archive
        working-directory: package
        run: |
          tar -czf ../${{ steps.version_vars.outputs.tag_name }}-linux-amd64.tar.gz *

      - name: Release and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          ARCHIVE_NAME="${{ steps.version_vars.outputs.tag_name }}-linux-amd64.tar.gz"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          # Upload the asset
          ls -la "$ARCHIVE_NAME" 2>/dev/null || echo "File not found"
          gh release upload "$TAG_NAME" ./"$ARCHIVE_NAME"

  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME"
          echo "VERSION=$VERSION"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortexd.service package/systemd/

      - name: Create DEB package
        run: |
          VERSION="${{ steps.version_vars.outputs.version }}"

          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/share/vortex
          mkdir -p deb-package/usr/share/doc/vortex

          cp target/x86_64-unknown-linux-gnu/release/vortex deb-package/usr/bin/
          chmod +x deb-package/usr/bin/vortex

          cp package/systemd/vortexd.service deb-package/usr/share/vortex/
          cp README.md LICENSE deb-package/usr/share/doc/vortex/

          cat > deb-package/DEBIAN/control << EOF
          Package: vortex
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Vortex Contributors <noreply@github.com>
          Description: Lightning-fast ephemeral VM platform
          Homepage: https://github.com/exec/vortex
          EOF

          cat > deb-package/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Vortex systemd service..."
          sudo cp /usr/share/vortex/vortexd.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable vortexd
          sudo systemctl start vortexd
          exit 0
          EOF
          chmod +x deb-package/DEBIAN/postinst

          cat > deb-package/DEBIAN/postrm << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "remove" ]; then
            sudo systemctl disable vortexd 2>/dev/null || true
            sudo systemctl stop vortexd 2>/dev/null || true
            sudo rm -f /etc/systemd/system/vortexd.service
            sudo systemctl daemon-reload
          fi
          exit 0
          EOF
          chmod +x deb-package/DEBIAN/postrm

          dpkg-deb --build deb-package vortex_${VERSION}_amd64.deb

      - name: Release and Upload DEB
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          VERSION="${{ steps.version_vars.outputs.version }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./vortex_${VERSION}_amd64.deb --clobber

  build-arch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME"
          echo "VERSION=$VERSION"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortexd.service package/systemd/

      - name: Create PKGARCH package
        run: |
          VERSION="${{ steps.version_vars.outputs.version }}"

          mkdir -p pkgarch-build/usr/bin
          mkdir -p pkgarch-build/usr/share/vortex
          mkdir -p pkgarch-build/usr/share/doc/vortex

          cp target/x86_64-unknown-linux-gnu/release/vortex pkgarch-build/usr/bin/
          chmod +x pkgarch-build/usr/bin/vortex

          cp package/systemd/vortexd.service pkgarch-build/usr/share/vortex/
          cp README.md LICENSE pkgarch-build/usr/share/doc/vortex/

          cat > pkgarch-build/.PKGINFO << EOF
          pkgname = vortex
          pkgver = $VERSION
          pkgdesc = Lightning-fast ephemeral VM platform
          url = https://github.com/exec/vortex
          builddate = $(date +%s)
          packager = Vortex Contributors <noreply@github.com>
          size = $(du -sb pkgarch-build | cut -f1)
          arch = x86_64
          license = MIT
          EOF

          cat > pkgarch-build/.MTREE << EOF
          #/.snapshots
          EOF

          cat > pkgarch-build/PKGBUILD << 'EOF'
          pkgname=vortex
          pkgver=$VERSION
          pkgrel=1
          pkgdesc="Lightning-fast ephemeral VM platform"
          arch=('x86_64')
          url="https://github.com/exec/vortex"
          license=('MIT')
          package() {
            mkdir -p "$pkgdir/usr/bin"
            cp /usr/bin/vortex "$pkgdir/usr/bin/"
            mkdir -p "$pkgdir/usr/share/vortex"
            cp /usr/share/vortex/vortexd.service "$pkgdir/usr/share/vortex/"
          }
          EOF

          cat > pkgarch-build/vortex.install << 'EOF'
          post_install() {
            cp /usr/share/vortex/vortexd.service /etc/systemd/system/
            systemctl daemon-reload
            systemctl enable vortexd
            systemctl start vortexd
          }
          post_remove() {
            systemctl disable vortexd 2>/dev/null || true
            systemctl stop vortexd 2>/dev/null || true
            rm -f /etc/systemd/system/vortexd.service
            systemctl daemon-reload
          }
          post_upgrade() { post_install; }
          EOF
          chmod +x pkgarch-build/vortex.install

          cd pkgarch-build
          tar -czf ../vortex-$VERSION-linux-amd64.pkg.tar.gz .
          cd ..

          cat > vortex-arch-install.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Installing Vortex..."
          VERSION="${1:-v0.5.0}"
          DOWNLOAD_URL="https://github.com/exec/vortex/releases/download/$VERSION/vortex-$VERSION-linux-amd64.pkg.tar.gz"
          TEMP_DIR=$(mktemp -d)
          curl -sL "$DOWNLOAD_URL" | tar -xzf - -C "$TEMP_DIR"
          sudo mkdir -p /usr/bin /usr/share/vortex /usr/share/doc/vortex
          sudo cp "$TEMP_DIR/usr/bin/vortex" /usr/bin/
          sudo cp "$TEMP_DIR/usr/share/vortex/vortexd.service" /usr/share/vortex/
          sudo cp /usr/share/vortex/vortexd.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable vortexd
          sudo systemctl start vortexd
          rm -rf "$TEMP_DIR"
          echo "Vortex installed successfully!"
          EOF
          chmod +x vortex-arch-install.sh

      - name: Release and Upload Arch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          VERSION="${{ steps.version_vars.outputs.version }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./vortex-$VERSION-linux-amd64.pkg.tar.gz --clobber
          gh release upload "$TAG_NAME" ./vortex-arch-install.sh --clobber

  build-rpm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          VERSION=${TAG_NAME#v}
          echo "TAG_NAME=$TAG_NAME"
          echo "VERSION=$VERSION"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential rpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Copy systemd service file
        run: |
          mkdir -p package/systemd
          cp ./systemd/vortexd.service package/systemd/

      - name: Build
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Create RPM package
        run: |
          VERSION="${{ steps.version_vars.outputs.version }}"

          mkdir -p rpm-build/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpm-build/SOURCES/vortex-$VERSION/{usr/bin,usr/share/vortex,usr/share/doc/vortex}

          cp target/x86_64-unknown-linux-gnu/release/vortex rpm-build/SOURCES/vortex-$VERSION/usr/bin/
          chmod +x rpm-build/SOURCES/vortex-$VERSION/usr/bin/vortex
          cp package/systemd/vortexd.service rpm-build/SOURCES/vortex-$VERSION/usr/share/vortex/
          cp README.md LICENSE rpm-build/SOURCES/vortex-$VERSION/usr/share/doc/vortex/

          cd rpm-build/SOURCES
          tar -czf vortex-$VERSION.tar.gz vortex-$VERSION/
          cd ../..

          cat > rpm-build/SPECS/vortex.spec << EOF
          Name:           vortex
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Lightning-fast ephemeral VM platform
          License:        MIT
          URL:            https://github.com/exec/vortex
          Source0:        %{name}-%{version}.tar.gz
          BuildArch:      x86_64

          %description
          Vortex is a powerful Rust CLI for creating and managing ephemeral
          microVMs using krunvm on macOS and Linux.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/vortex
          mkdir -p %{buildroot}/usr/share/doc/vortex
          cp usr/bin/vortex %{buildroot}/usr/bin/
          cp usr/share/vortex/vortexd.service %{buildroot}/usr/share/vortex/
          cp usr/share/doc/vortex/* %{buildroot}/usr/share/doc/vortex/

          %files
          /usr/bin/vortex
          /usr/share/vortex/vortexd.service
          /usr/share/doc/vortex/*

          %post
          cp /usr/share/vortex/vortexd.service /etc/systemd/system/
          systemctl daemon-reload
          systemctl enable vortexd
          systemctl start vortexd
          echo "Vortex installed successfully!"

          %changelog
          * $(date +"%%a %%b %%d %%Y") Vortex Contributors <noreply@github.com> - $VERSION-1
          - Release $VERSION
          EOF

          rpmbuild --define "_topdir $(pwd)/rpm-build" -bb rpm-build/SPECS/vortex.spec

          find rpm-build/RPMS -name "*.rpm" -exec cp {} ./vortex-$VERSION-1.x86_64.rpm \;

      - name: Release and Upload RPM
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          VERSION="${{ steps.version_vars.outputs.version }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./vortex-$VERSION-1.x86_64.rpm --clobber

  create-install-script:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag != '' && github.event.inputs.tag || github.ref_name }}

      - name: Set version variables
        id: version_vars
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG_NAME="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.5.0")
          fi
          echo "TAG_NAME=$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create universal install script
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"
          VERSION=${TAG_NAME#v}

          cat > install.sh << EOF
          #!/bin/bash

          # Vortex Universal Install Script
          # Automatically detects platform and installs the appropriate binary
          # Also installs the systemd service for user-level daemon management

          set -e

          # Colors for output
          RED='\\033[0;31m'
          GREEN='\\033[0;32m'
          YELLOW='\\033[1;33m'
          BLUE='\\033[0;34m'
          PURPLE='\\033[0;35m'
          CYAN='\\033[0;36m'
          NC='\\033[0m' # No Color

          # Print with colors
          print_status() { echo -e "\${BLUE}[INFO]\${NC} \$1"; }
          print_success() { echo -e "\${GREEN}[SUCCESS]\${NC} \$1"; }
          print_warning() { echo -e "\${YELLOW}[WARNING]\${NC} \$1"; }
          print_error() { echo -e "\${RED}[ERROR]\${NC} \$1"; }

          # Vortex version to install - automatically fetch latest from GitHub
          # Override with VORTEX_VERSION environment variable for testing
          REPO="exec/vortex"
          VERSION="${VERSION}"

          print_status "ðŸš€ Installing Vortex \${VERSION} - The Docker Killer"
          echo

          # Detect platform and architecture
          OS=\$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=\$(uname -m)

          case \$ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              armv7*) ARCH="armv7" ;;
              *) print_error "Unsupported architecture: \$ARCH"; exit 1 ;;
          esac

          case \$OS in
              linux)
                  print_status "Detected Linux system"
                  # Check if we're on Arch Linux
                  if [[ -f /etc/arch-release ]]; then
                      ARCH_PACKAGE_TYPE="arch"
                  elif [[ -f /etc/redhat-release ]] || command -v dnf &> /dev/null || command -v yum &> /dev/null; then
                      ARCH_PACKAGE_TYPE="rpm"
                  else
                      ARCH_PACKAGE_TYPE="generic"
                  fi

                  # Use simplified naming from GitHub Actions artifacts
                  if [[ \$ARCH == "amd64" ]]; then
                      if [[ \$ARCH_PACKAGE_TYPE == "arch" ]]; then
                          PACKAGE="vortex-\${VERSION}-x86_64-unknown-linux-gnu.pkg.tar.gz"
                      elif [[ \$ARCH_PACKAGE_TYPE == "rpm" ]]; then
                          # RPM packages are built as vortex-VERSION-1.x86_64.rpm
                          PACKAGE="vortex-\${VERSION}-1.x86_64.rpm"
                      else
                          PACKAGE="vortex-\${VERSION}-linux-amd64.tar.gz"
                      fi
                  elif [[ \$ARCH == "arm64" ]]; then
                      if [[ \$ARCH_PACKAGE_TYPE == "arch" ]]; then
                          print_error "Arch Linux ARM64 packages not yet available"
                          exit 1
                      elif [[ \$ARCH_PACKAGE_TYPE == "rpm" ]]; then
                          print_error "RPM ARM64 packages not yet available"
                          exit 1
                      else
                          PACKAGE="vortex-\${VERSION}-linux-arm64.tar.gz"
                      fi
                  else
                      print_error "Unsupported Linux architecture: \$ARCH (only amd64 and arm64 supported)"
                      exit 1
                  fi
                  INSTALL_CMD="tar -xzf"
                  ;;
              darwin)
                  print_status "Detected macOS system"
                  # Use simplified naming from GitHub Actions artifacts
                  if [[ \$ARCH == "arm64" ]]; then
                      PACKAGE="vortex-\${VERSION}-macos-arm64.tar.gz"
                  elif [[ \$ARCH == "amd64" ]]; then
                      PACKAGE="vortex-\${VERSION}-macos-amd64.tar.gz"
                  else
                      print_error "Unsupported macOS architecture: \$ARCH"
                      exit 1
                  fi
                  INSTALL_CMD="tar -xzf"
                  ;;
              *)
                  print_error "Unsupported operating system: \$OS"
                  exit 1
                  ;;
          esac

          # Download URL
          DOWNLOAD_URL="https://github.com/\${REPO}/releases/download/\${VERSION}/\${PACKAGE}"
          print_status "Downloading: \$PACKAGE"
          print_status "From: \$DOWNLOAD_URL"

          # Create temporary directory
          TEMP_DIR=\$(mktemp -d)
          cd "\$TEMP_DIR"

          # Download the package
          if command -v curl &> /dev/null; then
              curl -fsSL -o "\$PACKAGE" "\$DOWNLOAD_URL"
          elif command -v wget &> /dev/null; then
              wget -q -O "\$PACKAGE" "\$DOWNLOAD_URL"
          else
              print_error "Neither curl nor wget found. Please install one of them."
              exit 1
          fi

          print_success "Download completed!"

          # Install based on package type
          case \$PACKAGE in
              *.deb)
                  print_status "Installing Debian package..."
                  sudo dpkg -i "\$PACKAGE"
                  ;;
              *.rpm)
                  print_status "Installing RPM package..."
                  if command -v dnf &> /dev/null; then
                      sudo dnf install -y "\$PACKAGE"
                  elif command -v yum &> /dev/null; then
                      sudo yum install -y "\$PACKAGE"
                  else
                      # Fallback to rpm command if dnf/yum not available
                      sudo rpm -ivh "\$PACKAGE"
                  fi
                  ;;
              *.pkg.tar.gz)
                  print_status "Installing Arch package..."
                  \$INSTALL_CMD "\$PACKAGE"

                  # Find the vortex binary and copy it to /usr/bin
                  BINARY_PATH=\$(find . -name "vortex" -type f | head -1)
                  if [[ -n "\$BINARY_PATH" ]]; then
                      print_status "Installing binary to /usr/bin/vortex"
                      sudo cp "\$BINARY_PATH" /usr/bin/vortex
                      sudo chmod +x /usr/bin/vortex
                  else
                      print_error "Could not find vortex binary in extracted package"
                      exit 1
                  fi

                  # Install systemd service on Linux
                  print_status "Installing systemd service..."
                  SERVICE_PATH="\$TEMP_DIR/usr/share/vortex/vortexd.service"
                  if [[ -f "\$SERVICE_PATH" ]]; then
                      print_status "Found systemd service file"
                      print_status "Installing service to /etc/systemd/system/vortexd.service"
                      sudo cp "\$SERVICE_PATH" /etc/systemd/system/vortexd.service
                      sudo systemctl daemon-reload
                      sudo systemctl enable vortexd
                      sudo systemctl start vortexd
                      print_success "Systemd service installed and started!"
                  else
                      print_warning "Systemd service file not found - manual installation may be needed"
                  fi
                  ;;
              *.tar.gz)
                  print_status "Extracting binary..."
                  \$INSTALL_CMD "\$PACKAGE"

                  # Find the vortex binary and copy it to /usr/local/bin
                  BINARY_PATH=\$(find . -name "vortex" -type f | head -1)
                  if [[ -n "\$BINARY_PATH" ]]; then
                      print_status "Installing binary to /usr/local/bin/vortex"
                      if [[ \$OS == "darwin" ]]; then
                          sudo cp "\$BINARY_PATH" /usr/local/bin/vortex
                      else
                          sudo cp "\$BINARY_PATH" /usr/local/bin/vortex
                      fi
                      sudo chmod +x /usr/local/bin/vortex
                  else
                      print_error "Could not find vortex binary in extracted package"
                      exit 1
                  fi

                  # Install systemd service on Linux
                  if [[ \$OS == "linux" ]]; then
                      print_status "Installing systemd service..."
                      # Check if we're running from the source repo
                      if [[ -f "\$TEMP_DIR/systemd/vortexd.service" ]]; then
                          SERVICE_PATH="\$TEMP_DIR/systemd/vortexd.service"
                          print_status "Found systemd service file"
                      else
                          # Try to find from installed location
                          SERVICE_PATH="/usr/local/bin/../share/vortex/vortexd.service"
                          if [[ ! -f "\$SERVICE_PATH" ]]; then
                              print_warning "Systemd service file not found - manual installation may be needed"
                              SERVICE_PATH=""
                          fi
                      fi

                      if [[ -n "\$SERVICE_PATH" ]]; then
                          print_status "Installing service to /etc/systemd/system/vortexd.service"
                          sudo cp "\$SERVICE_PATH" /etc/systemd/system/vortexd.service
                          sudo systemctl daemon-reload
                          sudo systemctl enable vortexd
                          sudo systemctl start vortexd
                          print_success "Systemd service installed and started!"
                      fi
                  fi
                  ;;
          esac

          # Cleanup
          cd /
          rm -rf "\$TEMP_DIR"

          print_success "Vortex installation completed! ðŸŽ‰"
          echo
          print_status "Systemd service installed automatically on Linux! ðŸš€"
          echo
          print_status "Get started:"
          echo -e "  \${CYAN}vortex dev --list\${NC}              # List available templates"
          echo -e "  \${CYTHON}vortex dev --init\${NC}              # Create workspace from current directory"
          echo -e "  \${CYTHON}vortex session create\${NC}          # Create a new persistent VM session"
          echo -e "  \${CYTHON}vortex --help\${NC}                  # Show all available commands"
          echo
          print_status "Documentation: https://github.com/\${REPO}"
          print_success "Welcome to the future of development environments! 20x faster than Docker! ðŸš€"
          EOF

          chmod +x install.sh

      - name: Release and Upload Install Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version_vars.outputs.tag_name }}"

          # Create release if it doesn't exist
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes "" --draft=false --latest=false || true

          gh release upload "$TAG_NAME" ./install.sh --clobber
